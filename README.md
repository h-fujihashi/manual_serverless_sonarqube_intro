## Serverless Framework環境下でのユニットテスト環境構築
- 本稿はローカル環境下でのテストを想定しています。
- SonarQubeサーバーに分析情報を送信出来た時点で本稿を書いているので、結構曖昧な点があるかと思われます。
- 今回立ち上げるSonarQubeのサーバーはhomebrewを使用してパッケージを揃え、ローカルからアクセスしています。
- 手順通り行うにあたって、展開してもいい場所かどうかを予めお気をつけ下さい。

***
### 1. 必須nodeパッケージ
- serverless
- 各Serverlessプラグイン
    - serverless-mocha-plugin
        - テストコードのテンプレートを出力
    - mocha-sonar-reporter
        - mochaのテスト結果をSonarQubeで分析できる形式で出力
- mocha
- chai
- istanbul
- xunit-file
    - 必要ないと思われますが念のため

### 2. 必須homebrewパッケージ
- sonar
- sonar-scanner
- mysql

### 3. 手順
- まずはServerless環境準備します。作業フォルダを作成し、その直下に展開します
    1. `mkdir devsls && cd devsls`
    2. `npm install serverless -g`
    3. `serverless -v`
        - バージョンが表示される
    4. `serverless create --template aws-nodejs`
    
        >Serverless Framework
        >https://serverless.com/


- Serverlessの必須ファイルが展開されたのを確認してから、npmを初期化します
    1. `npm init`
        - 設定の入力を求められるのでひとまず全てEnterを押します。


- 各nodeパッケージをインストールします
    1. `npm install --save-dev serverless-mocha-plugin mocha-sonar-reporter mocha chai istanbul xunit-file`


- serverless.ymlの設定
    - Serverless Frameworkでプラグインを利用するために以下の記述を追加します
    ```
    plugins:
        - serverless-mocha-plugin
    ```


- package.jsonの設定
    - scripts > testの項目と新たにconfigの項目を以下のように上書き、または追加します

    ```
    "scripts": {
      "test": "istanbul cover node_modules/mocha/bin/_mocha -- -R mocha-sonar-reporter && sonar-scanner -X"
    },
    "config": {
        "mocha-sonar-reporter": {
          "outputfile": "test/report/TEST-all.xml"
        }
    }
    ```

- 動作テスト用のファイルの準備
    - 作成した作業フォルダ直下で`mkdir src && sudo vi calc.js`以下の内容を入力

    ```javascript:calc.js
    'use strict';

    module.exports.add = (event, context) => {
        let res = event.left + event.right;
        context.done(null, res);
    };
    ```

- テストファイルの作成
    1. `sls create test -f add --stage dev --region ap-northeast-1`
        - 現時点でステージとリージョンは適当で良いです
    2. 作業フォルダ直下に「test/add.js」が作成されるので以下の内容に書き換えます

    ```
    'use strict';

    // tests for add
    // Generated by serverless-mocha-plugin

    const mod = require('../src/calc.js');
    const mochaPlugin = require('serverless-mocha-plugin');

    const lambdaWrapper = mochaPlugin.lambdaWrapper;
    const expect = mochaPlugin.chai.expect;
    const assert = mochaPlugin.chai.assert;
    const wrapped = lambdaWrapper.wrap(mod, { handler: 'add' });

    describe('add', () => {
        before((done) => {
    // lambdaWrapper.init(liveFunction); // Run the deployed lambda

            done();
        });

        it('加算処理が正しい', () => {
            let left  = 2;
            let right = 1;
            return wrapped.run({"left":left,"right":right}).then((response) => {
                assert.strictEqual(left + right, response);
            });
        });
    });

    ```

- sonar-project.propertiesの作成
    1. 作業フォルダ直下で`sudo vi sonar-project.properties`以下の内容を入力

    ```
    sonar.language=js
    sonar.sources=src
    sonar.tests=test
    sonar.exclusions=test/**,coverage/**,node_modules/**
    sonar.javascript.lcov.reportPath=coverage/lcov.info
    sonar.javascript.forceZeroCoverage=true
    sonar.coverage.exclusions=test/**,coverage/**
    sonar.projectVersion=1.0.0-BUILD-SNAPSHOT
    ```

- homebrewのインストールと各homebrewパッケージをインストールします
    1. `/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"`
    
        >Homebrew macOS 用パッケージマネージャー
        >http://brew.sh/index_ja.html
        
    2. `brew install sonar`
    3. `brew install sonar-scanner`
    4. `brew install mysql`


- mysqlの準備
    1. `mysql -uroot`
    2. mysql> `create database sonar;`
    3. mysql> `CREATE USER 'sonar' IDENTIFIED BY 'sonar';`
    4. mysql> `GRANT ALL ON sonar.* TO 'sonar'@'%' IDENTIFIED BY 'sonar';`
    5. mysql> `GRANT ALL ON sonar.* TO 'sonar'@'localhost' IDENTIFIED BY 'sonar';`


- SonarQubeの準備
    1. `cd /usr/local/Cellar/sonarqube/6.1/libexec/conf`
        - 「sonarqube」直下のバージョンは異なる場合があるため、適宜書き換えて下さい。
    2. `sudo cp sonar.properties sonar.properties.org`
        - 念のためバックアップを取ります。
    3. `sudo vi sonar.properties`
        - 「DATABASE」欄にあるmysql設定項目を以下のように修正。

        ```text:sonar.properties

        #--------------------------------------------------------------------------------------------------
        # DATABASE
        #
        # IMPORTANT: the embedded H2 database is used by default. It is recommended for tests but not for
        # production use. Supported databases are MySQL, Oracle, PostgreSQL and Microsoft SQLServer.

        # User credentials.
        # Permissions to create tables, indices and triggers must be granted to JDBC user.
        # The schema must be created first.
        sonar.jdbc.username=sonar
        sonar.jdbc.password=sonar

        #----- Embedded Database (default)
        # H2 embedded database server listening port, defaults to 9092
        #sonar.embeddedDatabase.port=9092
        #----- MySQL 5.6 or greater
        # Only InnoDB storage engine is supported (not myISAM).
        # Only the bundled driver is supported. It can not be changed.
        sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true&useConfigs=maxPerformance
        ```

    4. `sonar console`
    5. ブラウザから http://localhost:9000/ を開いて表示されるかを確認。
    6. 6. SonarQubeサーバー停止時には別のターミナルから`sonar stop`


- SonarScannerの準備
    1. `cd /usr/local/Cellar/sonar-scanner/2.8/libexec/conf`
        - 「sonar-scanner」直下のバージョンは異なる場合があるため、適宜書き換えて下さい。
    2. `sudo cp sonar-scanner.properties sonar-scanner.properties.org`
        - 念のためバックアップを取ります。
    3. `sudo vi sonar-scanner.properties`
        - 「Default SonarQube server」
        - 「Default source code encoding」
        - 「Global database settings (not used for SonarQube 5.2+)」
        - 「MySQL」
        - の項目の修正と、末尾に「sonar.projectKey=HogeKey」を追加します。

        ```text:sonar-scanner.properties
        #Configure here general information about the environment, such as SonarQube DB details for example
        #No information about specific project should appear here

        #----- Default SonarQube server
        sonar.host.url=http://localhost:9000

        #----- Default source code encoding
        sonar.sourceEncoding=UTF-8

        #----- Global database settings (not used for SonarQube 5.2+)
        sonar.jdbc.username=sonar
        sonar.jdbc.password=sonar

        #----- PostgreSQL
        #sonar.jdbc.url=jdbc:postgresql://localhost/sonar

        #----- MySQL
        sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8

        #----- Oracle
        #sonar.jdbc.url=jdbc:oracle:thin:@localhost/XE

        #----- Microsoft SQLServer
        #sonar.jdbc.url=jdbc:jtds:sqlserver://localhost/sonar;SelectMethod=Cursor

        sonar.projectKey=HogeKey

        ```


- 動作テスト
    1. 作業フォルダ直下へと移動
    2. `npm test`
    3. ブラウザで http://localhost:9000 を開き、「HogeKey」がPROJECTSに追加されていることを確認
